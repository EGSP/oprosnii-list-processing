# Бизнес-логика (Business)

Модуль содержит чистые функции для бизнес-логики приложения, не зависящие от UI и внешних сервисов.

## Структура модуля

Расположение: `src/lib/business/`

## Документация требований

Требования к обработке заявок описаны в файле [`AGENTS.md`](AGENTS.md):

### Хранение данных

- **Файлы**: Технические условия (ТУ) и исходные файлы заявок
- **БД**: Заявки с метаданными (GUID, тип изделия, результаты OCR и LLM, даты обработки)

### Процесс обработки заявок

1. **Создание заявки**: Получаем заявку, задаем GUID имя файла, сохраняем в хранилище файл, записываем GUID в БД и возвращаем GUID.

2. **Определение типа изделия**: Получаем запрос на определение типа изделия для заявки, определяем тип изделия (OCR + LLM), записываем тип изделия в БД и возвращаем тип изделия.

3. **Формирование аббревиатуры**: Получаем запрос на формирование аббревиатуры с аргументом используемой ТУ, определяем параметры для формирования аббревиатуры (LLM) и возвращаем список определенных параметров со значениями.

**Важно**: OCR достаточно проделать единожды для файла, т.к. содержимое файла не меняется.

## Реализованные функции

### Обработка заявок

#### `detectProductType(applicationId: string): Promise<ProductTypeResult>`

Определяет тип изделия из заявки с использованием OCR и LLM.

**Процесс:**

1. Получает информацию о файле через `getFileInfo()` (включая уже извлеченный текст, если есть)
2. Если текст не извлечен, извлекает через OCR модуль (с кешированием результата в БД)
3. Если OCR операция асинхронная, возвращает `operationId` и флаг `isAsync: true` (не выбрасывает ошибку)
4. Если текст извлечен, вызывает LLM для определения типа изделия
5. Сохраняет результаты в БД
6. Возвращает структурированный результат

**Оптимизация:**

- Использует `getFileInfo()` для получения всех данных о файле один раз
- Автоматически использует уже извлеченный текст из завершенной OCR операции, если он есть
- Для многостраничных PDF автоматически использует async endpoint YandexOCR

**Асинхронные операции:**

- Если OCR операция асинхронная, функция возвращает результат с `isAsync: true` и `ocrOperationId`
- API endpoint должен обработать это и вернуть HTTP 202 (Accepted) с информацией об операции
- Клиент может использовать `checkAndUpdateOperation()` для проверки статуса операции

**Возвращает:**

```typescript
{
  result: {
    type: string;           // Тип изделия
    confidence?: number;     // Уровень уверенности (0-1)
    reasoning?: string;     // Обоснование выбора типа
  };
  ocrOperationId?: string;  // ID операции OCR
  llmOperationId?: string;  // ID операции LLM
}
```

**Ошибки:**

- `ProcessingError` - Ошибка при обработке заявки

#### `generateAbbreviation(applicationId: string, technicalSpecId: string): Promise<{ parameters: AbbreviationParameter[]; abbreviation: string }>`

Формирует аббревиатуру продукции на основе параметров из заявки и технических условий.

**Процесс:**

1. Валидирует существование заявки и ТУ
2. Получает текст через `getOrExtractText()`, который использует `getFileInfo()` для оптимизации
3. Ограничивает текст до 6000 символов (из конфига)
4. Формирует промпт с учетом ТУ через `buildAbbreviationPrompt()`
5. Вызывает LLM для извлечения параметров через `extractParametersWithLLM()`
6. Валидирует параметры и формирует аббревиатуру через `validateAndGenerateAbbreviation()`
7. Сохраняет результаты в БД через `saveAbbreviationResult()`

**Оптимизация:**

- `getOrExtractText()` использует `getFileInfo()`, который проверяет уже извлеченный текст из OCR операции
- Избегает повторного чтения файла и определения его характеристик

**Возвращает:**

```typescript
{
  parameters: AbbreviationParameter[];  // Валидированные параметры
  abbreviation: string;                 // Сформированная аббревиатура
  ocrOperationId?: string;              // ID операции OCR
  llmOperationId?: string;              // ID операции LLM
}
```

**Ошибки:**

- `ProcessingError` - Ошибка при обработке заявки

### Вспомогательные функции (внутренние)

Функция `generateAbbreviation` разбита на атомарные функции для улучшения тестируемости и переиспользования:

#### `getOrExtractText(applicationId: string): Promise<{text: string, ocrOperationId?: string}>`

Получает текст из существующей OCR операции или извлекает новый. Проверяет статус операции перед использованием результата. Обрабатывает асинхронные операции.

#### `buildAbbreviationPrompt(text: string, technicalSpec: TechnicalSpec): string`

Формирует промпт для LLM на основе текста заявки и технических условий.

#### `extractParametersWithLLM(applicationId: string, prompt: string, systemPrompt: string): Promise<{parameters: AbbreviationParameter[], llmOperationId?: string}>`

Вызывает LLM для извлечения параметров аббревиатуры. Возвращает параметры и ID операции LLM.

#### `validateAndGenerateAbbreviation(parameters: AbbreviationParameter[], technicalSpec: TechnicalSpec): {parameters: AbbreviationParameter[], abbreviation: string}`

Валидирует параметры по правилам ТУ и формирует аббревиатуру по шаблону.

#### `saveAbbreviationResult(applicationId: string, result: {parameters, abbreviation, technicalSpecId}): void`

Сохраняет результат формирования аббревиатуры в БД заявки.

#### `getOperationStatus(operationId: string): ProcessingOperation | null`

Получает статус операции обработки по ID.

**Параметры:**

- `operationId` - UUID операции

**Возвращает:** Объект операции или `null`, если операция не найдена

#### `checkAndUpdateOperation(operationId: string): Promise<ProcessingOperation | null>`

Проверяет и обновляет статус асинхронной операции у внешнего сервиса. Автоматически синхронизирует результат завершенной операции с таблицей `applications`.

**Параметры:**

- `operationId` - UUID операции

**Возвращает:** Обновленный объект операции или `null`, если операция не найдена

**Примечание:** 
- Для OCR операций от Yandex проверяет статус через API. Для других типов операций просто возвращает текущий статус.
- Если операция завершена, автоматически синхронизирует результат с заявкой через `syncOperationToApplication()`.

### Zod схемы для structured output

Модуль использует Zod схемы для валидации ответов от LLM:

- **`ProductTypeSchema`** - Схема для результата определения типа изделия
- **`AbbreviationParametersSchema`** - Схема для параметров аббревиатуры

Схемы находятся в `schemas.ts` вместе с функциями валидации:

- `validateParametersAgainstTU()` - Валидация параметров по правилам ТУ
- `generateAbbreviation()` - Формирование аббревиатуры по шаблону

## Интеграция с AI модулем

Модуль бизнес-логики использует модуль AI (`../ai/`) для:

- Извлечения текста из файлов через OCR
- Вызова LLM для анализа текста
- Structured output через Zod схемы

Подробнее см. [`../ai/AI.md`](../ai/AI.md)

## Интеграция с хранилищем

Модуль бизнес-логики использует модуль хранилища (`../storage/`) для сохранения и получения данных:

- Работа с заявками через репозиторий
- Сохранение и чтение файлов заявок
- Получение технических условий
- Работа с операциями обработки через `operationsRepository`

Подробнее см. [`../storage/STORAGE.md`](../storage/STORAGE.md)

## Операции обработки

Все функции обработки создают операции в БД для отслеживания статуса:

- **OCR операции**: Создаются при извлечении текста через `extractText()` (внутри `callYandexOCR` в `yandex/ocr.ts`)
- **LLM операции**: Создаются при вызове LLM с указанием `operationConfig`

Операции позволяют:

- Отслеживать статус обработки (pending, running, completed, failed)
- Получать результаты и ошибки
- Проверять статус асинхронных операций через `checkAndUpdateOperation()`

Подробнее об операциях см. [`../storage/STORAGE.md`](../storage/STORAGE.md#репозиторий-операций-обработки-operationsrepositoryts)
