<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 8a0e4170-1dee-4690-b107-8bea90751c1f (2025-12-20 14:08Z) -->

# Effect type error in ocr.ts (2025-12-20 14:08Z)

_**User (2025-12-20 10:50Z)**_

For the code present, we get this error:
```
Type 'Effect<{ id: string; applicationId: string; task: "extractText" | "resolveProductType" | "resolveAbbreviation"; status: "started" | "completed" | "failed"; data: { [x: string]: unknown; result?: unknown; service?: string | undefined; }; startDate: string; finishDate?: string | ... 1 more ... | undefined; } | Effect<...' is not assignable to type 'Effect<{ id: string; applicationId: string; task: "extractText" | "resolveProductType" | "resolveAbbreviation"; status: "started" | "completed" | "failed"; data: { [x: string]: unknown; result?: unknown; service?: string | undefined; }; startDate: string; finishDate?: string | ... 1 more ... | undefined; }, Error, n...'.
  Type '{ id: string; applicationId: string; task: "extractText" | "resolveProductType" | "resolveAbbreviation"; status: "started" | "completed" | "failed"; data: { [x: string]: unknown; result?: unknown; service?: string | undefined; }; startDate: string; finishDate?: string | ... 1 more ... | undefined; } | Effect<...>' is not assignable to type '{ id: string; applicationId: string; task: "extractText" | "resolveProductType" | "resolveAbbreviation"; status: "started" | "completed" | "failed"; data: { [x: string]: unknown; result?: unknown; service?: string | undefined; }; startDate: string; finishDate?: string | ... 1 more ... | undefined; }'.
    Type 'Effect<never, OCRError, never>' is missing the following properties from type '{ id: string; applicationId: string; task: "extractText" | "resolveProductType" | "resolveAbbreviation"; status: "started" | "completed" | "failed"; data: { [x: string]: unknown; result?: unknown; service?: string | undefined; }; startDate: string; finishDate?: string | ... 1 more ... | undefined; }': id, applicationId, task, status, and 2 more.
```
Fix it, verify, and then give a concise explanation. @src/lib/ai/ocr.ts:118-121 

---

_**Agent (model default, mode Ask)**_



---


Reviewing the file to understand the context and identify the issue.


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/lib/ai/ocr.ts</summary>

</details>
</tool-use>

---



---


Checking the return type of `updateOperation` to understand the type mismatch:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/lib/storage/processingOperations.ts</summary>

</details>
</tool-use>

---



---


The issue is on line 133: inside `Effect.gen`, use `yield* Effect.fail(...)` instead of `return Effect.fail(...)` to propagate the error.

Here's the fix:

```typescript:src/lib/ai/ocr.ts
// ... existing code ...
		default:
			yield* Effect.fail(new OCRError('Не поддерживаемый тип файла'));
// ... existing code ...
```

**Explanation:** In `Effect.gen`, `return Effect.fail(...)` returns an `Effect` directly, which breaks the generator's type. Use `yield* Effect.fail(...)` so the generator unwraps and propagates the error, keeping the return type consistent with the other branches that return `ProcessingOperation` from `updateOperation`.

---

