<!-- a09a870a-6763-4866-a858-94d7a6b3d090 df222dd2-e9ac-455d-be13-7d2dbf8affbf -->
# План реализации: AI-система обработки технических заявок

## Этап 1: Настройка проекта и инфраструктуры

### 1.1 Инициализация SvelteKit проекта

- Создать SvelteKit проект с TypeScript
- Настроить структуру папок: `lib/business/`, `routes/api/`, `lib/components/`
- Настроить ESLint, Prettier
- Добавить зависимости: LangChain.js, Zod, библиотеки для работы с файлами

### 1.2 Настройка хранилища данных

- **Рекомендация**: SQLite для начала (легко мигрировать на PostgreSQL)
- Создать схему БД: таблицы для заявок, результатов обработки, ТУ
- Настроить ORM/query builder (Drizzle ORM или Prisma)
- Создать миграции

### 1.3 Настройка AI и OCR

- **LLM**: Настроить LangChain.js с Yandex GPT, предоставить возможность передавать разные модели
- **OCR**: Интегрировать API сервис Yandex OCR.
- Создать модули в `lib/business/ai/` для работы с LLM и OCR

### 1.4 Конфигурация

- Создать `.env` с переменными окружения
- Настроить конфиг для лимитов файлов, размеров текста для LLM

## Этап 2: Бизнес-логика (lib/business/)

### 2.1 Модели данных и Zod схемы

- Определить структуру технических параметров (Zod схемы)
- Создать типы для заявок, результатов, ТУ
- Схема для structured output от LLM

### 2.2 Модуль работы с файлами

- `lib/business/file-processing.ts`: извлечение текста из PDF, DOCX, XLSX
- Интеграция OCR для изображений и PDF
- Обработка ошибок и валидация форматов

### 2.3 Модуль работы с ТУ

- `lib/business/tu-loader.ts`: загрузка ТУ из JSON файлов
- Валидация структуры ТУ
- Кэширование ТУ в памяти

### 2.4 Модуль извлечения параметров (AI)

- `lib/business/parameter-extraction.ts`: промпт для LLM с контекстом ТУ
- Использование LangChain structured output с Zod
- Ограничение текста (6000 символов, настраиваемо)
- Валидация извлеченных параметров

### 2.5 Модуль формирования аббревиатуры

- `lib/business/abbreviation-generator.ts`: логика составления аббревиатуры по ТУ
- Сопоставление кодов с ТУ (например, ВД, У1)
- Валидация результата

### 2.6 Модуль работы с БД

- `lib/business/db/`: CRUD операции для заявок и результатов
- Функции для экспорта в Excel

## Этап 3: REST API (routes/api/)

### 3.1 Эндпоинты для заявок

- `POST /api/requests` - создание заявки (загрузка файла, выбор ТУ)
- `GET /api/requests` - список заявок с фильтрацией
- `GET /api/requests/:id` - детали заявки
- `GET /api/requests/:id/result` - результат обработки

### 3.2 Эндпоинты для обработки

- `POST /api/process` - запуск обработки заявки (асинхронно)
- `GET /api/process/:id/status` - статус обработки

### 3.3 Эндпоинты для ТУ

- `GET /api/tu` - список доступных ТУ
- `GET /api/tu/:id` - детали ТУ

### 3.4 Эндпоинт экспорта

- `GET /api/export/excel` - экспорт заявок в Excel

## Этап 4: Web UI

### 4.1 Главная страница (routes/)

- Форма загрузки файла с drag-n-drop
- Selectbox для выбора ТУ
- Поле для примечаний
- Кнопка "Обработать"
- Отображение результата (аббревиатура продукции)

### 4.2 Компоненты (lib/components/)

- `FileUpload.svelte` - компонент загрузки файлов
- `TUSelector.svelte` - выбор ТУ
- `ProcessingStatus.svelte` - статус обработки
- `ResultDisplay.svelte` - отображение результата

### 4.3 Дашборд (routes/dashboard/)

- Таблица заявок с пагинацией
- Фильтры по датам
- Просмотр деталей заявки
- Кнопка экспорта в Excel

## Этап 5: Асинхронная обработка

### 5.1 Реализация очереди задач

- **Рекомендация**: простой механизм с polling или WebSockets
- Статусы: pending, processing, completed, error
- Обновление статуса через API

### 5.2 Логирование

- Сохранение шагов обработки в `messages` для отладки
- Логи ошибок

## Этап 6: Тестирование и доработка

### 6.1 Тестирование бизнес-логики

- Unit тесты для чистых функций в `lib/business/`
- Тесты для извлечения параметров
- Тесты для формирования аббревиатуры

### 6.2 Интеграционное тестирование

- Тесты API эндпоинтов
- Тесты обработки файлов разных форматов

### 6.3 Обработка ошибок

- Валидация входных данных
- Обработка ошибок OCR/LLM
- Пользовательские сообщения об ошибках

## Рекомендации по заполнению пробелов

1. **Хранилище**: SQLite для разработки, миграция на PostgreSQL для продакшена
2. **LLM**: OpenAI GPT-4 с structured output (лучшая поддержка Zod схем)
3. **OCR**: Google Cloud Vision API (хорошее качество, доступная цена)
4. **Структура ТУ**: JSON с полями: id, name, rules (массив правил для параметров), abbreviationTemplate
5. **Аутентификация**: добавить позже при необходимости (JWT токены)
6. **Лимиты**: 10MB на файл, 6000 символов для LLM (настраиваемо)

## Файлы для создания

- `lib/business/file-processing.ts` - обработка файлов
- `lib/business/parameter-extraction.ts` - извлечение параметров через LLM
- `lib/business/abbreviation-generator.ts` - формирование аббревиатуры
- `lib/business/tu-loader.ts` - загрузка ТУ
- `lib/business/db/schema.ts` - схема БД
- `routes/api/requests/+server.ts` - API для заявок
- `routes/api/process/+server.ts` - API для обработки
- `lib/components/FileUpload.svelte` - компонент загрузки
- `routes/+page.svelte` - главная страница
- `routes/dashboard/+page.svelte` - дашборд